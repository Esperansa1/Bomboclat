---
phase: 01-scaffold
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/config.rs
  - src/main.rs
  - .env.example
autonomous: true
requirements:
  - CONN-02
  - PROT-03

must_haves:
  truths:
    - "Binary reads CSGOROLL_API_TOKEN, CSGOROLL_SESSION, and CAPSOLVER_API_KEY from env or .env and logs all three present"
    - "Binary exits with a non-zero code and a clear error message naming the missing variable when any credential is absent"
    - "No credentials are logged in plaintext — only 'loaded' confirmation messages"
  artifacts:
    - path: "src/config.rs"
      provides: "Credential loading and validation module"
      contains: "pub struct Config"
    - path: "src/main.rs"
      provides: "Entry point that calls config::load() before any other work"
      contains: "config::load"
    - path: ".env.example"
      provides: "Template showing the three required environment variable names"
      contains: "CSGOROLL_API_TOKEN"
  key_links:
    - from: "src/main.rs"
      to: "src/config.rs"
      via: "mod config; config::load() called at top of main()"
      pattern: "config::load"
    - from: "src/config.rs"
      to: "dotenvy"
      via: "dotenvy::dotenv().ok() called before std::env::var"
      pattern: "dotenvy::dotenv"
    - from: "src/config.rs"
      to: "std::env::var"
      via: "Each of the three var names fetched individually; missing any → process::exit(1)"
      pattern: "std::env::var"

user_setup:
  - service: csgoroll
    why: "Authentication credentials for WebSocket and HTTP buy requests"
    env_vars:
      - name: CSGOROLL_API_TOKEN
        source: "CSGORoll account settings or developer/API section"
      - name: CSGOROLL_SESSION
        source: "CSGORoll session cookie — extract from browser DevTools after login (Application > Cookies)"
  - service: capsolver
    why: "CapSolver API key for resolving Cloudflare and captcha challenges on the buy endpoint"
    env_vars:
      - name: CAPSOLVER_API_KEY
        source: "CapSolver Dashboard (https://dashboard.capsolver.com) -> API Key"
---

<objective>
Implement credential loading from environment variables / .env file with startup validation that exits cleanly on missing credentials.

Purpose: Satisfies CONN-02 and PROT-03 — the bot cannot operate without these three secrets. Failing fast at startup with a clear error is safer and more debuggable than crashing inside the async loop.
Output: `src/config.rs` module with a `Config` struct and `load()` function; updated `src/main.rs`; `.env.example` template.
</objective>

<execution_context>
@C:/Users/oresp/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/oresp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scaffold/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement config module with credential loading and startup validation</name>
  <files>src/config.rs</files>
  <action>
Create `src/config.rs` with a `Config` struct holding the three required credentials and a `load()` function that:

1. Calls `dotenvy::dotenv().ok()` first — this loads `.env` if present; `.ok()` silently ignores missing file (env vars may come from the OS environment in production)
2. Reads each of the three required env vars using `std::env::var()`
3. If any var is missing or empty, prints a clear error message to stderr naming the specific missing variable and exits with code 1
4. On success, returns a `Config` struct and prints a startup confirmation message to stdout

```rust
use std::env;
use std::process;

pub struct Config {
    pub csgoroll_api_token: String,
    pub csgoroll_session: String,
    pub capsolver_api_key: String,
}

impl Config {
    pub fn load() -> Self {
        // Load .env file if present; silently ignore if missing (env vars may be set externally)
        dotenvy::dotenv().ok();

        let csgoroll_api_token = Self::require_var("CSGOROLL_API_TOKEN");
        let csgoroll_session = Self::require_var("CSGOROLL_SESSION");
        let capsolver_api_key = Self::require_var("CAPSOLVER_API_KEY");

        println!(
            "[config] All credentials loaded: CSGOROLL_API_TOKEN=***, CSGOROLL_SESSION=***, CAPSOLVER_API_KEY=***"
        );

        Config {
            csgoroll_api_token,
            csgoroll_session,
            capsolver_api_key,
        }
    }

    fn require_var(name: &str) -> String {
        match env::var(name) {
            Ok(val) if !val.is_empty() => val,
            Ok(_) => {
                eprintln!("[config] ERROR: Environment variable '{}' is set but empty", name);
                process::exit(1);
            }
            Err(_) => {
                eprintln!(
                    "[config] ERROR: Required environment variable '{}' is not set. \
                     Set it in your environment or in a .env file.",
                    name
                );
                process::exit(1);
            }
        }
    }
}
```

Do NOT log credential values in plaintext — only masked (`***`) confirmation. This is a security requirement: credential values must never appear in logs or stdout.
  </action>
  <verify>
    <automated>cd /c/Users/oresp/Desktop/ActuallyRollingInMoney && cargo build 2>&1 | tail -5</automated>
    <manual>Inspect src/config.rs: confirm no credential value is printed in plaintext in any log/println call</manual>
  </verify>
  <done>src/config.rs compiles without errors; contains `pub struct Config` with three String fields; `load()` calls dotenvy::dotenv().ok() before env::var(); missing var causes process::exit(1) with named error message</done>
</task>

<task type="auto">
  <name>Task 2: Wire config into main.rs and create .env.example</name>
  <files>src/main.rs, .env.example</files>
  <action>
**Update src/main.rs** to declare and call the config module at the top of `main()`, before any other logic:

```rust
mod config;

#[tokio::main]
async fn main() {
    let _config = config::Config::load();
    // Phase 2 will use _config for WebSocket authentication
    println!("CSGORoll Sniper ready.");
}
```

The `_config` prefix suppresses the unused-variable warning without discarding the value (important: the struct will be used in Phase 2 — do not use `let _ = ...` which drops immediately).

**Create .env.example** at the project root:

```
# CSGORoll Skin Sniper — required environment variables
# Copy this file to .env and fill in your credentials

# CSGORoll API token (from account settings or developer API section)
CSGOROLL_API_TOKEN=your_api_token_here

# CSGORoll session cookie value (from browser DevTools after login)
CSGOROLL_SESSION=your_session_cookie_here

# CapSolver API key (from https://dashboard.capsolver.com)
CAPSOLVER_API_KEY=your_capsolver_api_key_here
```

**Verify startup behavior** with a test run using all three vars set:

```bash
CSGOROLL_API_TOKEN=test_token CSGOROLL_SESSION=test_session CAPSOLVER_API_KEY=test_capsolver cargo run
```

Expected output:
```
[config] All credentials loaded: CSGOROLL_API_TOKEN=***, CSGOROLL_SESSION=***, CAPSOLVER_API_KEY=***
CSGORoll Sniper ready.
```

Also verify the missing-var behavior:

```bash
CSGOROLL_API_TOKEN=test_token cargo run 2>&1
```

Expected: exits with a non-zero code and prints `[config] ERROR: Required environment variable 'CSGOROLL_SESSION' is not set...`
  </action>
  <verify>
    <automated>cd /c/Users/oresp/Desktop/ActuallyRollingInMoney && CSGOROLL_API_TOKEN=tok CSGOROLL_SESSION=sess CAPSOLVER_API_KEY=cap cargo run 2>&1 && echo "EXIT:$?"</automated>
    <manual>Run without CSGOROLL_SESSION set and confirm exit code is non-zero and error message names the missing variable</manual>
  </verify>
  <done>
    1. `cargo run` with all three vars set prints "[config] All credentials loaded..." and "CSGORoll Sniper ready." then exits 0
    2. `cargo run` with CSGOROLL_SESSION unset exits non-zero and prints error naming 'CSGOROLL_SESSION'
    3. `cargo run` with CAPSOLVER_API_KEY unset exits non-zero and prints error naming 'CAPSOLVER_API_KEY'
    4. .env.example exists at project root with all three variable names documented
  </done>
</task>

</tasks>

<verification>
Full phase acceptance check — run all three scenarios:

```bash
cd /c/Users/oresp/Desktop/ActuallyRollingInMoney

# Scenario 1: all credentials present
CSGOROLL_API_TOKEN=tok CSGOROLL_SESSION=sess CAPSOLVER_API_KEY=cap cargo run
echo "Scenario 1 exit: $?"

# Scenario 2: missing CSGOROLL_SESSION
CSGOROLL_API_TOKEN=tok CAPSOLVER_API_KEY=cap cargo run 2>&1
echo "Scenario 2 exit: $?"

# Scenario 3: missing CAPSOLVER_API_KEY
CSGOROLL_API_TOKEN=tok CSGOROLL_SESSION=sess cargo run 2>&1
echo "Scenario 3 exit: $?"
```

Scenario 1 must exit 0 and print confirmation.
Scenarios 2 and 3 must exit non-zero and name the missing variable.
</verification>

<success_criteria>
1. `cargo build` succeeds with all dependencies from Cargo.toml compiling
2. Binary with all three env vars set logs "[config] All credentials loaded..." (no plaintext values) and exits 0
3. Binary missing any one of the three vars exits non-zero with a message naming the specific missing variable
4. .env.example documents all three required variable names
5. No credential values appear in stdout, stderr, or source code
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold/01-02-SUMMARY.md` with:
- Confirmation that all three credential vars are validated at startup
- Final src/config.rs structure (struct fields, public API)
- Any Rust edition or compiler warnings encountered and how they were resolved
- Confirmation that .env.example is present and correct
</output>
