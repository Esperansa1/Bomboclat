---
phase: 02-websocket-connection
status: blocked_cf_bypass
last_updated: 2026-02-25T17:28:02.999Z
---

<current_state>
Phase 2 execution complete, code correct, but WS connection returns 403 Forbidden from Cloudflare. Need __cf_bm cookie added AND CapSolver integration to get cf_clearance dynamically. User confirmed both __cf_bm exists and wants CapSolver as the long-term solution.
</current_state>

<completed_work>
- Phase 2 both plans executed: src/ws.rs (Trade struct, graphql-transport-ws, connect_once, run_with_reconnect)
- Auth corrected: no API token, session cookie + cf_clearance via Cookie header
- Switched native-tls → rustls (fixes Windows TLS error)
- Config now has: CSGOROLL_SESSION, CF_CLEARANCE, CAPSOLVER_API_KEY
- cookie_header() method composes: "session=...; cf_clearance=..."
- All pushed to https://github.com/Esperansa1/Bomboclat.git master
</completed_work>

<remaining_work>
IMMEDIATE: Add __cf_bm to cookie_header() in config.rs:
  - Add `cf_bm: String` field to Config struct
  - Add CF_BM env var loading in Config::load()
  - Update cookie_header() to: "session={}; cf_clearance={}; __cf_bm={}"
  - Update .env.example

THEN TEST: If still 403 after adding __cf_bm → Cloudflare TLS fingerprint issue → need CapSolver to get fresh cookies

LONG TERM (Phase 4 scope, possibly pull forward):
  - Use CapSolver to get cf_clearance dynamically before each WS connection
  - CapSolver task type for Cloudflare: AntiTurnstileTaskProxyless or AntiCloudflareTask
  - Call CapSolver REST API via reqwest to get fresh cf_clearance before connecting
  - Phase 4 already planned for CapSolver on buy endpoint — extend to WS connection too
</remaining_work>

<decisions_made>
- Auth: session cookie + cf_clearance + __cf_bm (all from browser cookies)
- CF bypass strategy: CapSolver (user confirmed)
- No API token — pure cookie auth
- WS URL: wss://router.csgoroll.com/ws
- Protocol: graphql-transport-ws, connection_init has NO payload
- Cookie domain: set for csgoroll.com (applies to router.csgoroll.com subdomain)
- example_data/ has: websocket_request.txt, create_trade_subscription.txt, create_trade_response.txt
</decisions_made>

<next_action>
1. Add CF_BM env var to config.rs + update cookie_header() to include __cf_bm
2. Test cargo run — if still 403, pull CapSolver forward to get cookies dynamically
3. CapSolver REST API: POST https://api.capsolver.com/createTask with AntiCloudflareTask
4. Once WS connects and prints trades → approve Phase 2 → plan Phase 3
</next_action>
